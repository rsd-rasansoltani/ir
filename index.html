<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>پنل حسابداری — MKstudio</title>
<style>
:root{--bg:#0b1220;--card:#0f1722;--muted:#9aa6b2;--accent:#5eead4;--accent2:#60a5fa;--glass:rgba(255,255,255,0.03);--danger:#ff6b6b}
*{box-sizing:border-box;font-family:Tahoma,Arial,Helvetica,sans-serif}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#071029 0%, #081428 100%);color:#e6eef8}
.app{display:flex;min-height:100vh}
.sidebar{width:260px;padding:20px;background:linear-gradient(180deg,#071226 0%, #081428 100%);border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column}
.brand h1{margin:0;color:var(--accent);font-size:20px}
.brand p{margin:2px 0 12px;color:var(--muted);font-size:13px}
.admin-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.admin-info{display:flex;align-items:center;gap:8px}
.admin-info #adminName{color:#fff;font-weight:700}
.menu{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.menu button{background:transparent;border:none;color:var(--muted);padding:12px;text-align:right;border-radius:8px;cursor:pointer}
.menu button.active{background:linear-gradient(90deg, rgba(96,165,250,0.12), rgba(94,234,212,0.06));color:var(--accent2);font-weight:700}
.sidebar-footer{margin-top:auto}
.logout{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}

/* main */
.main{flex:1;padding:18px;display:flex;flex-direction:column;min-height:100vh}
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.clock{background:var(--glass);padding:8px 12px;border-radius:10px;text-align:right}
.clock #time{font-weight:700}
.clock #jalali{color:var(--muted);font-size:13px}
.search-area input{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;min-width:220px}

/* tabs & cards */
.tab{display:none}
.tab.show{display:block}
.dash-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.summary{grid-column:span 4}
.chartcard{grid-column:span 8;min-height:260px}
.notes{grid-column:span 4;display:flex;flex-direction:column;gap:8px}
.notes textarea{min-height:120px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
.notes .notes-actions{display:flex;gap:8px;justify-content:flex-end}
.metrics{display:flex;gap:8px;justify-content:space-between;margin-top:10px}
.m{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;flex:1;text-align:center}
.m-title{color:var(--muted);font-size:13px}
.m-value{font-weight:800;font-size:20px;color:var(--accent)}

/* forms and tables */
.form-inline{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.form-inline input,.form-inline select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
.form-inline button{padding:10px;border-radius:8px;border:none;background:var(--accent2);color:#021;cursor:pointer}
.data-table{width:100%;border-collapse:collapse;margin-top:12px;background:transparent;border-radius:8px;overflow:hidden}
.data-table th,.data-table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center;color:var(--muted)}

/* invoice */
.invoice-panel{display:flex;gap:12px}
.invoice-panel .left{flex:2}
.invoice-panel .right{width:260px}

/* responsive */
@media (max-width:900px){
  .sidebar{display:none}
  .dash-grid{grid-template-columns:repeat(1,1fr)}
  .chartcard{min-height:200px}
  .notes{order:2}
}
.footer{margin-top:12px;color:var(--muted);text-align:center;padding:8px}
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="sidebar">
    <div class="brand"><h1>MKstudio</h1><p class="role">پنل</p></div>
    <div class="admin-row"><div class="admin-info"><div id="adminName">MKstudio16</div></div></div>
    <nav class="menu">
      <button data-tab="dashboard" class="active">خانه</button>
      <button data-tab="products">محصولات</button>
      <button data-tab="customers">مشتریان</button>
      <button data-tab="invoice">فاکتور</button>
      <button data-tab="lottery">قرعه‌کشی / گزارش</button>
    </nav>
    <div class="sidebar-footer"><button id="clearStorage" class="logout">پاک‌کردن داده‌ها</button></div>
  </aside>

  <main class="main">
    <header class="topbar">
      <div class="clock"><div id="time">--:--:--</div><div id="jalali">--</div></div>
      <div class="search-area"><input id="globalSearch" placeholder="جستجو..." /></div>
    </header>

    <section id="dashboard" class="tab show">
      <div class="dash-grid">
        <div class="card summary"><h3>خلاصه</h3>
          <div class="metrics">
            <div class="m"><div class="m-title">فروش</div><div id="total-sales" class="m-value">0</div></div>
            <div class="m"><div class="m-title">هزینه</div><div id="total-cost" class="m-value">0</div></div>
            <div class="m"><div class="m-title">سود</div><div id="total-profit" class="m-value">0</div></div>
          </div></div>

        <div class="card notes"><h3>یادداشت‌ها</h3>
          <textarea id="notesArea" placeholder="یادداشت جدید..."></textarea>
          <div class="notes-actions"><button id="saveNote">ذخیره</button><button id="clearNote">پاک کردن</button></div>
        </div>

        <div class="card chartcard"><h3>نمودار فروش</h3><canvas id="salesChart"></canvas></div>
      </div>
    </section>

    <section id="products" class="tab">
      <h2>محصولات</h2>
      <form id="productForm" class="form-inline">
        <input id="p_name" placeholder="نام محصول" required />
        <select id="p_country">
          <option value="IR">ایران</option><option value="US">آمریکا</option><option value="CN">چین</option><option value="TR">ترکیه</option><option value="DE">آلمان</option>
        </select>
        <input id="p_cost" type="number" placeholder="قیمت خرید" min="0" required />
        <input id="p_price" type="number" placeholder="قیمت فروش" min="0" required />
        <button type="submit">افزودن</button>
      </form>
      <input id="productSearch" placeholder="جستجو محصول..." />
      <table class="data-table" id="productsTable"><thead><tr><th>کد</th><th>نام</th><th>کشور</th><th>خرید</th><th>فروش</th><th>سود</th></tr></thead><tbody></tbody></table>
    </section>

    <section id="customers" class="tab">
      <h2>مشتریان</h2>
      <form id="customerForm" class="form-inline">
        <input id="c_name" placeholder="نام و نام خانوادگی" required />
        <input id="c_mobile" placeholder="شماره موبایل" required />
        <input id="c_dob" type="date" />
        <button type="submit">افزودن</button>
      </form>
      <div class="customer-actions"><input id="customerSearch" placeholder="جستجو مشتری..." /><button id="drawBtn">قرعه‌کشی</button></div>
      <table class="data-table" id="customersTable"><thead><tr><th>کد اشتراک</th><th>نام</th><th>موبایل</th><th>تاریخ تولد</th></tr></thead><tbody></tbody></table>
      <div id="winnerBox" class="hidden card"></div>
    </section>

    <section id="invoice" class="tab">
      <h2>فاکتور</h2>
      <div class="invoice-panel">
        <div class="left">
          <label>مشتری</label>
          <select id="invoiceCustomer"><option value="">-- انتخاب مشتری --</option></select>
          <label>محصول</label>
          <select id="invoiceProduct"><option value="">-- انتخاب محصول --</option></select>
          <input id="invoiceQty" type="number" min="1" value="1" />
          <button id="addInvoiceItem">افزودن</button>
          <table class="data-table" id="invoiceItems"><thead><tr><th>محصول</th><th>تعداد</th><th>قیمت واحد</th><th>مبلغ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="right card">
          <h3>خلاصه</h3>
          <p>جمع: <span id="invoiceSubtotal">0</span></p>
          <p>تخفیف: <span id="invoiceDiscount">0</span></p>
          <p>نهایی: <span id="invoiceTotal">0</span></p>
          <button id="saveInvoice">ذخیره فاکتور</button>
        </div>
      </div>
      <div id="invoicesList" class="card"><h3>فاکتورهای ذخیره‌شده</h3><ul id="invoicesUl"></ul></div>
    </section>

    <section id="lottery" class="tab">
      <h2>قرعه‌کشی و گزارش</h2>
      <button id="showAllSales">نمایش تمام فاکتورها</button>
      <div id="reports"></div>
    </section>

    <footer class="footer">© MKstudio</footer>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// state
let state = {
  products: JSON.parse(localStorage.getItem('products')||'[]'),
  customers: JSON.parse(localStorage.getItem('customers')||'[]'),
  invoices: JSON.parse(localStorage.getItem('invoices')||'[]'),
  notes: localStorage.getItem('mk_notes')||''
};

// Clock & Jalali
function toJalaali(gy,gm,gd){
  var g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];var gy2=gy-1600;var gm2=gm-1;var gd2=gd-1;
  var g_day_no=365*gy2+Math.floor((gy2+3)/4)-Math.floor((gy2+99)/100)+Math.floor((gy2+399)/400);
  g_day_no += gd2 + g_d_m[gm2];
  if(gm2>1 && ((gy%4==0 && gy%100!=0) || (gy%400==0))) g_day_no++;
  var j_day_no = g_day_no-79; var j_np = Math.floor(j_day_no/12053);
  j_day_no = j_day_no % 12053; var jy = 979 + 33*j_np + 4*Math.floor(j_day_no/1461);
  j_day_no %= 1461;
  if(j_day_no >= 366){ jy += Math.floor((j_day_no-1)/365); j_day_no = (j_day_no-1)%365; }
  var jm=0,jd=0; var jalali_month_days=[31,31,31,31,31,31,30,30,30,30,30,29];
  for(var i=0;i<11;i++){ if(j_day_no >= jalali_month_days[i]) j_day_no -= jalali_month_days[i]; else { jm = i+1; jd = j_day_no+1; break; } }
  if(jm==0){ jm=12; jd=j_day_no+1; } return [jy,jm,jd];
}
function updateClock(){ const now=new Date(); document.getElementById('time').innerText = now.toLocaleTimeString('fa-IR'); const [jy,jm,jd] = toJalaali(now.getFullYear(), now.getMonth()+1, now.getDate()); document.getElementById('jalali').innerText = `${jd}/${jm}/${jy}`; }
setInterval(updateClock,1000); updateClock();

// Utilities
function uid(prefix='X'){ return prefix + Math.random().toString(36).slice(2,9).toUpperCase(); }
function saveState(){ localStorage.setItem('products', JSON.stringify(state.products)); localStorage.setItem('customers', JSON.stringify(state.customers)); localStorage.setItem('invoices', JSON.stringify(state.invoices)); localStorage.setItem('mk_notes', state.notes||''); updateDashboard(); }

// Tabs
document.querySelectorAll('.menu button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('show'));
    document.getElementById(btn.dataset.tab).classList.add('show');
    if(btn.dataset.tab === 'dashboard') updateDashboard();
  });
});

// Products
document.getElementById('productForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('p_name').value.trim();
  const country = document.getElementById('p_country').value;
  const cost = parseFloat(document.getElementById('p_cost').value)||0;
  const price = parseFloat(document.getElementById('p_price').value)||0;
  const countryCount = state.products.filter(p=>p.country===country).length + 1;
  const code = country + '-' + String(countryCount).padStart(4,'0');
  const id = uid('P');
  const profit = price - cost;
  state.products.push({id,code,name,country,cost,price,profit});
  saveState(); document.getElementById('productForm').reset(); refreshProducts();
});
document.getElementById('productSearch').addEventListener('input', refreshProducts);
function refreshProducts(){ const q = document.getElementById('productSearch').value.trim().toLowerCase(); const tbody = document.querySelector('#productsTable tbody'); tbody.innerHTML=''; state.products.filter(p=>p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q)).forEach(p=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.code}</td><td>${p.name}</td><td>${p.country}</td><td>${p.cost}</td><td>${p.price}</td><td>${(p.profit).toFixed(2)}</td>`; tbody.appendChild(tr); }); populateSelects(); }

// Customers
document.getElementById('customerForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('c_name').value.trim();
  const mobile = document.getElementById('c_mobile').value.trim();
  const dob = document.getElementById('c_dob').value || '';
  const code = generateSubscriptionCode(name,mobile);
  state.customers.push({id:uid('C'),code,name,mobile,dob});
  saveState(); document.getElementById('customerForm').reset(); refreshCustomers();
});
function generateSubscriptionCode(name,mobile){
  const initials = name.split(' ').map(s=>s[0]||'').join('').slice(0,3).toUpperCase();
  const digits = mobile.replace(/\D/g,'').slice(-4) || Math.floor(Math.random()*9000)+1000;
  return `S-${initials}-${digits}-${Date.now().toString().slice(-4)}`;
}
document.getElementById('customerSearch').addEventListener('input', refreshCustomers);
function refreshCustomers(){ const q = document.getElementById('customerSearch').value.trim().toLowerCase(); const tbody = document.querySelector('#customersTable tbody'); tbody.innerHTML=''; state.customers.filter(c=> c.name.toLowerCase().includes(q) || c.mobile.includes(q) || c.code.toLowerCase().includes(q)).forEach(c=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${c.code}</td><td>${c.name}</td><td>${c.mobile}</td><td>${c.dob}</td>`; tbody.appendChild(tr); }); }

// Lottery
document.getElementById('drawBtn').addEventListener('click', ()=>{
  if(state.customers.length===0){ alert('هیچ مشتری ذخیره‌شده‌ای وجود ندارد'); return; }
  const idx = Math.floor(Math.random()*state.customers.length);
  const winner = state.customers[idx];
  const box = document.getElementById('winnerBox'); box.classList.remove('hidden'); box.innerHTML = `<h3>برنده: ${winner.name}</h3><p>کد: ${winner.code}</p><p>موبایل: ${winner.mobile}</p>`;
});

// Invoice
function populateSelects(){ const customerSel = document.getElementById('invoiceCustomer'); const productSel = document.getElementById('invoiceProduct'); customerSel.innerHTML = '<option value="">-- انتخاب مشتری --</option>'; productSel.innerHTML = '<option value="">-- انتخاب محصول --</option>'; state.customers.forEach(c=> customerSel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name} (${c.code})</option>`)); state.products.forEach(p=> productSel.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name} — ${p.code} — ${p.price}</option>`)); }
document.getElementById('addInvoiceItem').addEventListener('click', ()=>{ const pid = document.getElementById('invoiceProduct').value; const qty = parseInt(document.getElementById('invoiceQty').value)||1; if(!pid){ alert('ابتدا محصول را انتخاب کنید'); return; } const product = state.products.find(p=>p.id===pid); const tbody = document.querySelector('#invoiceItems tbody'); const tr = document.createElement('tr'); tr.dataset.pid = pid; tr.innerHTML = `<td>${product.name}</td><td>${qty}</td><td>${product.price}</td><td>${(product.price*qty).toFixed(2)}</td><td><button class="removeItem">حذف</button></td>`; tbody.appendChild(tr); updateInvoiceSummary(); });
document.querySelector('#invoiceItems tbody').addEventListener('click', e=>{ if(e.target.classList.contains('removeItem')){ e.target.closest('tr').remove(); updateInvoiceSummary(); } });
function updateInvoiceSummary(){ const rows = Array.from(document.querySelectorAll('#invoiceItems tbody tr')); let subtotal=0; rows.forEach(r=>{ const qty = parseInt(r.children[1].innerText) || 0; const price = parseFloat(r.children[2].innerText) || 0; subtotal += qty*price; }); let discount=0; const totalQty = rows.reduce((s,r)=>s + (parseInt(r.children[1].innerText)||0),0); if(totalQty>=10) discount=0.10*subtotal; else if(totalQty>=5) discount=0.05*subtotal; const total = subtotal-discount; document.getElementById('invoiceSubtotal').innerText = subtotal.toFixed(2); document.getElementById('invoiceDiscount').innerText = discount.toFixed(2); document.getElementById('invoiceTotal').innerText = total.toFixed(2); }
document.getElementById('saveInvoice').addEventListener('click', ()=>{ const custId = document.getElementById('invoiceCustomer').value; if(!custId){ alert('مشتری انتخاب نشده'); return; } const rows = Array.from(document.querySelectorAll('#invoiceItems tbody tr')); if(rows.length===0){ alert('هیچ آیتمی وجود ندارد'); return; } const items = rows.map(r=>{ const pid = r.dataset.pid; const p = state.products.find(x=>x.id===pid); const qty = parseInt(r.children[1].innerText)||1; return {pid,pname:p.name,price:p.price,qty,amount: p.price*qty}; }); const subtotal = parseFloat(document.getElementById('invoiceSubtotal').innerText)||0; const discount = parseFloat(document.getElementById('invoiceDiscount').innerText)||0; const total = parseFloat(document.getElementById('invoiceTotal').innerText)||0; const inv = {id:uid('I'),customer:custId,customerName:state.customers.find(c=>c.id===custId).name,items,subtotal,discount,total,date:new Date().toISOString()}; state.invoices.push(inv); saveState(); document.querySelector('#invoiceItems tbody').innerHTML=''; refreshInvoices(); alert('فاکتور ذخیره شد'); });
function refreshInvoices(){ const ul = document.getElementById('invoicesUl'); ul.innerHTML=''; state.invoices.forEach(inv=>{ const li = document.createElement('li'); li.innerHTML = `<strong>${inv.customerName}</strong> — ${inv.date.split('T')[0]} — مبلغ: ${inv.total.toFixed(2)} <button data-id="${inv.id}" class="viewInv">نمایش</button>`; ul.appendChild(li); }); updateDashboard(); }
document.getElementById('invoicesUl').addEventListener('click', e=>{ if(e.target.classList.contains('viewInv')){ const id = e.target.dataset.id; const inv = state.invoices.find(i=>i.id===id); alert(JSON.stringify(inv, null, 2)); } });
document.getElementById('showAllSales').addEventListener('click', ()=>{ const reports = document.getElementById('reports'); reports.innerHTML = '<h3>فاکتور‌ها</h3>'; state.invoices.forEach(inv=>{ reports.innerHTML += `<div class="card"><strong>${inv.customerName}</strong> — ${inv.date.split('T')[0]} — ${inv.total.toFixed(2)}</div>`; }); });

// Notes
document.getElementById('notesArea').value = state.notes || '';
document.getElementById('saveNote').addEventListener('click', ()=>{ state.notes = document.getElementById('notesArea').value || ''; saveState(); alert('یادداشت ذخیره شد'); });
document.getElementById('clearNote').addEventListener('click', ()=>{ if(confirm('پاک شود؟')){ state.notes=''; document.getElementById('notesArea').value=''; saveState(); } });

// Dashboard chart
let salesChart;
function updateDashboard(){
  const totalSales = state.invoices.reduce((s,i)=>s + (i.total||0),0);
  const totalCost = state.invoices.reduce((s,i)=>{ let c=0; i.items.forEach(it=>{ const p = state.products.find(x=>x.id===it.pid); if(p) c += (p.cost||0)*it.qty; }); return s + c; },0);
  const profit = totalSales - totalCost;
  document.getElementById('total-sales').innerText = totalSales.toFixed(2);
  document.getElementById('total-cost').innerText = totalCost.toFixed(2);
  document.getElementById('total-profit').innerText = profit.toFixed(2);

  const grouped = {}; state.invoices.forEach(inv=>{ const d = inv.date.split('T')[0]; grouped[d] = (grouped[d]||0) + inv.total; });
  const labels = Object.keys(grouped).sort(); const data = labels.map(l=>grouped[l]);
  if(salesChart){ salesChart.data.labels = labels; salesChart.data.datasets[0].data = data; salesChart.update(); }
  else { const ctx = document.getElementById('salesChart').getContext('2d'); salesChart = new Chart(ctx, {type:'bar', data:{labels, datasets:[{label:'فروش', data}]}, options:{responsive:true, plugins:{legend:{display:false}}}}); }
}

// Helpers & init
function refreshAll(){ refreshProducts(); refreshCustomers(); refreshInvoices(); updateDashboard(); }
function refreshProducts(){ const q = document.getElementById('productSearch').value.trim().toLowerCase(); const tbody = document.querySelector('#productsTable tbody'); tbody.innerHTML=''; state.products.filter(p=>p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q)).forEach(p=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.code}</td><td>${p.name}</td><td>${p.country}</td><td>${p.cost}</td><td>${p.price}</td><td>${(p.profit).toFixed(2)}</td>`; tbody.appendChild(tr); }); populateSelects(); }
function refreshCustomers(){ const q = document.getElementById('customerSearch').value.trim().toLowerCase(); const tbody = document.querySelector('#customersTable tbody'); tbody.innerHTML=''; state.customers.filter(c=> c.name.toLowerCase().includes(q) || c.mobile.includes(q) || c.code.toLowerCase().includes(q)).forEach(c=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${c.code}</td><td>${c.name}</td><td>${c.mobile}</td><td>${c.dob}</td>`; tbody.appendChild(tr); }); }
function populateSelects(){ const customerSel = document.getElementById('invoiceCustomer'); const productSel = document.getElementById('invoiceProduct'); customerSel.innerHTML = '<option value="">-- انتخاب مشتری --</option>'; productSel.innerHTML = '<option value="">-- انتخاب محصول --</option>'; state.customers.forEach(c=> customerSel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name} (${c.code})</option>`)); state.products.forEach(p=> productSel.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name} — ${p.code} — ${p.price}</option>`)); }
function uid(prefix='X'){ return prefix + Math.random().toString(36).slice(2,9).toUpperCase(); }

// clear storage button
document.getElementById('clearStorage').addEventListener('click', ()=>{
  if(confirm('آیا می‌خواهید تمام داده‌های ذخیره‌شده پاک شوند؟')){
    localStorage.removeItem('products'); localStorage.removeItem('customers'); localStorage.removeItem('invoices'); localStorage.removeItem('mk_notes');
    state = {products:[], customers:[], invoices:[], notes:''};
    refreshAll(); alert('داده‌ها پاک شدند');
  }
});

// init
saveState(); refreshAll();
</script>
</body>
</html>
